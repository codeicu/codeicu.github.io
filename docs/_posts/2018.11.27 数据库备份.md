---
title: 数据库备份
date: 2018-11-27 16:40:57
tags: Database
---
MySQL备份（Backup）与 恢复（Restore）汇总<br style="word-spacing:normal;">
1.mysqldump<br style="word-spacing:normal;">
2.mysqlbackup<br style="word-spacing:normal;">
3.mysqlhotcopy<br style="word-spacing:normal;">
4.xtrabackup/innobackupex<br style="word-spacing:normal;">
5.cp<br style="word-spacing:normal;">
备份备于一切，今天汇总一下常用的几种备份方法，以及恢复的步骤。</p>
<h1 style="font-size:30px;font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.8;color:rgb(51,51,51);border:none;"><a name="t0"></a>
1.mysqldump</h1>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
在日常工作中，我们会使用mysqldump命令创建sql格式的转储文件来备份数据库。或者我们把数据导出后做数据迁移，主备搭建等操作。mysqldump是一个逻辑备份工具,复制原始的数据库对象定义和表数据产生一组可执行的SQL语句。 默认情况下,生成insert语句，也能生成其它分隔符的输出或XML格式的文件。<br style="word-spacing:normal;">
shell&gt; mysqldump [arguments] &gt; file_name</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
我们简单的来看一下日常的用法：<br style="word-spacing:normal;">
备份所有的数据库：<br style="word-spacing:normal;">
shell&gt; mysqldump --all-databases &gt; dump.sql (不包含INFORMATION_SCHEMA,performance_schema,sys，如果想要导出的话还要结合--skip-lock-tables和--database一起用)<br style="word-spacing:normal;">
备份指定的数据库：<br style="word-spacing:normal;">
shell&gt; mysqldump --databases db1 db2 db3 &gt; dump.sql<br style="word-spacing:normal;">
当我们只备份一个数据的时候可以省去 --databases 直接写成：mysqldump test &gt; dump.sql 不过有一些细微的差别，如果不加的话，数据库转储输出不包含创建数据库和use语句，所以可以不加这个参数直接导入到其它名字的数据库里<br style="word-spacing:normal;">
当然我们也可以只备份某个表 ：<br style="word-spacing:normal;">
mysqldump --user [username] --password=[password] [database name] [table name] table_name.sql</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
了解了简单的一些用法后我们再着重的看一下几个参数：</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
--master-data 获取备份数据的Binlog位置和Binlog文件名，用于通过备份恢复的实例之间建立复制关系时使用，该参数会默认开启。<br style="word-spacing:normal;">
--dump-slave 用于在slave上dump数据，建立新的slave。因为我们在使用mysqldump时会锁表，所以大多数情况下，我们的导出操作一般会在只读备库上做，为了获取主库的Relay_Master_Log_File和Exec_Master_Log_Pos，需要用到这个参数，不过这个参数只有在5.7以后的才会有<br style="word-spacing:normal;">
–no-data, -d 不导出任何数据，只导出数据库表结构</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
刚刚我们说过在使用mysqldump的时候会锁表，我们来详细的看一下它的锁机制。</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
我们开两个窗口，在第一个里面执行mysqldump -uroot -pxxxxx --master-data=2 --databases dbname &gt; /tmp/dbname<code style="word-spacing:normal;font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:rgb(199,37,78);border:1px solid rgb(221,221,221);background:rgb(246,246,246);">date
 +%F</code>.sql<br style="word-spacing:normal;">
然后第二个窗口登陆进去，使用show process的命令可以看到目前dump的session正在执行&nbsp;<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493545935.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493545935.png" alt="1.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
SELECT /*!40001 SQL_NO_CACHE */ * FROM table_name; 可以看到这条sql正在以no_cache的模式查询数据。<br style="word-spacing:normal;">
然后我们在同样的表上执行一下select，发现被阻塞了。光标一直不返回。<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493545949.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493545949.png" alt="2.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
一般遇到这种文件，我们会想是不是有锁呢？<br style="word-spacing:normal;">
为了验证我们查看一下锁的信息，可以发现dump的进程实际上是加了锁的。<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493545960.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493545960.png" alt="3.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
我们把具体的general_log打开，然后看一下当时的操作：<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493545971.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493545971.png" alt="4.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
4101044 Query FLUSH /*!40101 LOCAL */ TABLES<br style="word-spacing:normal;">
4101044 Query FLUSH TABLES WITH READ LOCK （关闭所有打开的表，同时对于所有数据库中的表都加一个读锁，直到显示地执行unlock tables，该操作常常用于数据备份的时候。）<br style="word-spacing:normal;">
4101044 Query SHOW MASTER STATUS（这是因为我用了--master-data=2）<br style="word-spacing:normal;">
所以这个时候表就会被锁住。<br style="word-spacing:normal;">
如果我不加--master-data参数(mysqldump -uroot -pxx --databases db &gt; /tmp/dbname<code style="word-spacing:normal;font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:rgb(199,37,78);border:1px solid rgb(221,221,221);background:rgb(246,246,246);">date
 +%F</code>.sql) mysql会显示的对每一张要备份的表执行<br style="word-spacing:normal;">
LOCK TABLES&nbsp;<code style="word-spacing:normal;font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:rgb(199,37,78);border:1px solid rgb(221,221,221);background:rgb(246,246,246);">table_name1</code>&nbsp;READ,LOCK
 TABLES&nbsp;<code style="word-spacing:normal;font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:rgb(199,37,78);border:1px solid rgb(221,221,221);background:rgb(246,246,246);">table_name2</code>&nbsp;READ<br style="word-spacing:normal;">
并且也不会有读的阻塞。<br style="word-spacing:normal;">
那有没有不锁的方法，其实也是有的，就是使用--single-transaction把备份的操作放在一个事务里去进行<br style="word-spacing:normal;">
带上--single-transaction参数的mysqldump备份过程：<br style="word-spacing:normal;">
如果是5.6版本的mysql<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493546024.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493546024.png" alt="5.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
在备份之间同样的先FLUSH TABLES WITH READ LOCK，然后设置事务级别SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ，然后开启一个事务START TRANSACTION进行备份，这个时候备份的过程就很意思，它先创建了一个savepoint，然后把数据库里的表依次的进行备份，备份完成了之后又回滚到了之前的savepoint，来保证数据的一致性<br style="word-spacing:normal;">
如果是5.7版本的mysql<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493546033.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493546033.png" alt="6.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
备份前的操作相同，只是没有了savepoint</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
不过不管是哪个版本，只有InnoDB表是在一个一致性的状态。其它的任何MyISAM表或内存表是没有用的。<br style="word-spacing:normal;">
mysqldump的优势是可以查看或者编辑十分方便，它也可以灵活性的恢复之前的数据。它也不关心底层的存储引擎，既适用于支持事务的，也适用于不支持事务的表。不过它不能作为一个快速备份大量的数据或可伸缩的解决方案。如果数据库过大,即使备份步骤需要的时间不算太久,但有可能恢复数据的速度也会非常慢,因为它涉及的SQL语句插入磁盘I/O,创建索引等等。<br style="word-spacing:normal;">
对于大规模的备份和恢复,更合适的做法是物理备份,复制其原始格式的数据文件,可以快速恢复:如果你的表主要是InnoDB表,或者如果你有一个InnoDB和MyISAM表,可以考虑使用MySQL的mysqlbackup命令备份</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
恢复操作：<br style="word-spacing:normal;">
先看一下当前的数据：<br style="word-spacing:normal;">
dbadmin@test 11:10:34&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
1 row in set (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
备份；<br style="word-spacing:normal;">
mysqldump -uroot -proot@1234 --master-data=1 test &gt;test.sql</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
模拟增量操作：<br style="word-spacing:normal;">
dbadmin@test 11:15:17&gt;insert into t values (2);<br style="word-spacing:normal;">
Query OK, 1 row affected (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
dbadmin@test 11:15:36&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
2 rows in set (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
模拟误操作：<br style="word-spacing:normal;">
dbadmin@test 11:15:41&gt;truncate table t;<br style="word-spacing:normal;">
Query OK, 0 rows affected (0.01 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
dbadmin@test 11:16:14&gt;select * from t;<br style="word-spacing:normal;">
Empty set (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
摸拟恢复操作：<br style="word-spacing:normal;">
step 1:找到误操作的log position<br style="word-spacing:normal;">
dbadmin@test 11:20:57&gt;show master logs;<br style="word-spacing:normal;">
dbadmin@(none) 11:21:37&gt;show binlog events in 'mysql-bin.000004';<br style="word-spacing:normal;">
查看可以看到是444<br style="word-spacing:normal;">
step 2:<br style="word-spacing:normal;">
恢复到备份<br style="word-spacing:normal;">
dbadmin@test 11:16:25&gt;source test.sql<br style="word-spacing:normal;">
dbadmin@test 11:17:26&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
1 row in set (0.00 sec)<br style="word-spacing:normal;">
step 3:<br style="word-spacing:normal;">
因为我们在备份的时候使用了master-data的参数，所以可以直接看到备份时候的最后位置，然后应用中间的log。<br style="word-spacing:normal;">
查看可以看到是187<br style="word-spacing:normal;">
我们使用mysqlbinlog得到这一段时间的操作，其实我们也可以用这个工具得到操作后使用sed进行undo的操作。<br style="word-spacing:normal;">
mysqlbinlog --start-position=187 --stop-position=444 mysql-bin.000004 &gt; increment.sql<br style="word-spacing:normal;">
dbadmin@test 11:44:37&gt;source /u01/my3307/log/increment.sql<br style="word-spacing:normal;">
dbadmin@test 11:44:50&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
至此数据恢复。</p>
<h1 style="font-size:30px;font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.8;color:rgb(51,51,51);border:none;"><a name="t1"></a>
2.mysqlbackup</h1>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
是ORACLE公司提供的针对企业的备份软件，全名叫做MySQL Enterprise Backup，是一个收费的软件。 下载地址：https://www.mysql.com/products/enterprise/backup.html 可以试用下载。我们简单的来看一下这个工具的使用。<br style="word-spacing:normal;">
查看所有的帮助：<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493546078.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493546078.png" alt="7.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
我这里只是截取了一小部分，这个帮助很长，参数很多，功能很全，是oracle官方主推的备份方式。<br style="word-spacing:normal;">
全量备份<br style="word-spacing:normal;">
mysqlbackup --user=root --password=ucjmh --databases='t1' --encrypt-password=1 --with-timestamp --backup-dir=/u01/backup/ backup<br style="word-spacing:normal;">
解释一下参数：<br style="word-spacing:normal;">
--databases 要备份的数据库&nbsp;<br style="word-spacing:normal;">
--with-timestamp 产生一个当前时间的备份目录。mysqlbackup这个工具要求一个空目录才能做备份。所以这个会常用<br style="word-spacing:normal;">
--backup-dir 备份的目录<br style="word-spacing:normal;">
--compress：压缩备份 这个提供了多种压缩方法和压缩级别。1--9,压缩比依次递增<br style="word-spacing:normal;">
backup 是备份的方式，&nbsp;<br style="word-spacing:normal;">
一共有如下几种方式，我会在一个恢复案例里把常用的几个都用到<br style="word-spacing:normal;">
Backup operations: backup, backup-and-apply-log, backup-to-image<br style="word-spacing:normal;">
Update operations: apply-log, apply-incremental-backup<br style="word-spacing:normal;">
Restore operations: copy-back, copy-back-and-apply-log<br style="word-spacing:normal;">
Validation operation: validate<br style="word-spacing:normal;">
Single-file backup operations: image-to-backup-dir, backup-dir-to-image, list-image, extract<br style="word-spacing:normal;">
其实，在大多数情况下,单个文件备份,使用backup-to-image命令创建,性能优于backup。buckup这个命令只执行一个完整的备份过程的初始阶段。需要通过再次运行mysqlbackup运用apply-log 命令,使备份一致。<br style="word-spacing:normal;">
mysqlbackup --user=root --password=ucjmh --databases='t1' --encrypt-password=1 --with-timestamp --backup-dir=/u01/backup/2017-04-28_12-49-35/ apply-log<br style="word-spacing:normal;">
当然你可以直接用backup-and-apply-log 不过这个时候的备份将不能用于增量了。<br style="word-spacing:normal;">
增量备份：<br style="word-spacing:normal;">
mysqlbackup --user=root --password=ucjmh --databases='t1' --encrypt-password=1 --with-timestamp --backup-dir=/u01/backup/ --incremental --incremental-base=dir:/u01/backup/2017-04-28_12-49-35 --incremental-backup-dir=/u01/backup/incremental backup<br style="word-spacing:normal;">
这个是基于上次的备份做的备份，当然也可以基于某一个log position之后做。<br style="word-spacing:normal;">
--incremental：代表增量备份；<br style="word-spacing:normal;">
--incremental-base：上次全备的目录；<br style="word-spacing:normal;">
--incremental-backup-dir：增量备份的保存的目录</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
再多说一点关于image的备份:<br style="word-spacing:normal;">
使用如下命令可以进行备份<br style="word-spacing:normal;">
mysqlbackup --user=root --password=ucjmh --databases='t1' --encrypt-password=1 --with-timestamp --backup-dir=/u01/backup/ --backup-image=all.mbi backup-to-image<br style="word-spacing:normal;">
备份之后可以很清楚的发现这个比backup要节省很多空间，把所有的文件都以二进制的方式放在了all.mbi这个文件里，可以使用list-image来查看具体内容。<br style="word-spacing:normal;">
mysqlbackup --backup-image=/u01/backup/2017-04-28_14-50-17/all.mbi list-image<br style="word-spacing:normal;">
同样的也可以使用<br style="word-spacing:normal;">
mysqlbackup --backup-image=/u01/backup/2017-04-28_14-50-17/all.mbi extract<br style="word-spacing:normal;">
来解压出来具体的内容。<br style="word-spacing:normal;">
因为这是一个oracle出的工具，有很深的rman的影子在，0级，1级备份，加密，异构机器还原等特性。<br style="word-spacing:normal;">
更多的参数可以参看online help：<br style="word-spacing:normal;">
https://dev.mysql.com/doc/mysql-enterprise-backup/4.1/en/backup-commands-single-file.html</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
恢复操作：<br style="word-spacing:normal;">
查看当前数据<br style="word-spacing:normal;">
dbadmin@test 11:51:32&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
1 row in set (0.01 sec)<br style="word-spacing:normal;">
全量备份<br style="word-spacing:normal;">
mysqlbackup --user=root --password=root@1234 --databases='test' --with-timestamp --backup-dir=/data/backup/ backup</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
模拟增量操作：<br style="word-spacing:normal;">
dbadmin@test 11:54:04&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
2 rows in set (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
增量备份：<br style="word-spacing:normal;">
mysqlbackup --user=root --password=root@1234 --databases='test' --with-timestamp --backup-dir=/data/backup/ --incremental --incremental-base=dir:/data/backup/2017-04-29_11-53-20 --incremental-backup-dir=/data/backup/incremental backup</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
模拟无备份操作：<br style="word-spacing:normal;">
dbadmin@test 11:57:10&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
| 3 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
3 rows in set (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
模拟误操作：<br style="word-spacing:normal;">
dbadmin@test 11:57:17&gt;truncate table t;<br style="word-spacing:normal;">
Query OK, 0 rows affected (0.01 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
摸拟恢复操作：<br style="word-spacing:normal;">
step 1:找到误操作的log position<br style="word-spacing:normal;">
dbadmin@test 11:58:06&gt;show master logs;<br style="word-spacing:normal;">
dbadmin@test 11:58:18&gt;show binlog events in 'mysql-bin.000001';<br style="word-spacing:normal;">
1333<br style="word-spacing:normal;">
step 2:恢复全量<br style="word-spacing:normal;">
检测并应用日志：<br style="word-spacing:normal;">
mysqlbackup --backup-dir=/data/backup/2017-04-29_11-53-20 apply-log&nbsp;<br style="word-spacing:normal;">
step 3:应用增量<br style="word-spacing:normal;">
mysqlbackup --backup-dir=/data/backup/2017-04-29_11-53-20 --incremental-backup-dir=/data/backup/incremental/2017-04-29_11-55-54 apply-incremental-backup&nbsp;<br style="word-spacing:normal;">
step 4:物理文件复制还原<br style="word-spacing:normal;">
mysqlbackup --backup-dir=/data/backup/2017-04-29_11-53-20 copy-back</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
数据恢复到备份的时候：<br style="word-spacing:normal;">
dbadmin@test 12:09:49&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
2 rows in set (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
恢复完成之后，data目录下会生成backup_variables.txt的文件（其实在备份的时候就已经有这些文件的），找到备份的时候的log position,然后从binlog恢复无备份的数据<br style="word-spacing:normal;">
binlog_position=mysql-bin.000001:1076<br style="word-spacing:normal;">
mysqlbinlog mysql-bin.000001 --start-position=1076 --stop-position=1333 -vv &gt;increment.sql&nbsp;<br style="word-spacing:normal;">
dbadmin@test 12:14:07&gt;source /u01/my3307/log/increment.sql<br style="word-spacing:normal;">
dbadmin@test 12:14:16&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
| 3 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
3 rows in set (0.00 sec)<br style="word-spacing:normal;">
至此数据恢复。<br style="word-spacing:normal;">
大致梳理一下操作步骤，来了解一下恢复的原理：<br style="word-spacing:normal;">
首先检测并应用全备事务日志文件（这里是因为我备份的时候用的是backup而不是backup-and-apply-log），然后基于全备去应用增量的log。这个时候如果有多次增量备份也可以（基于LSN点向后应用）。 所有的都应用完成之后就是一个可以直接cp的数据库了。</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
个人感觉这个工具比xtrabackup好用，但是xtrabackup是开源的，所以市场占有量才会大，才会更有名，更多人用吧。</p>
<h1 style="font-size:30px;font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.8;color:rgb(51,51,51);border:none;"><a name="t2"></a>
3.mysqlhotcopy</h1>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
mysqlhotcopy使用lock tables、flush tables和cp或scp来快速备份数据库.它是备份数据库或单个表最快的途径,完全属于物理备份,但只能用于备份MyISAM存储引擎和ARCHIVE引擎，并且是一个服务器命令，只能运行在数据库目录所在的机器上.与mysqldump备份不同,mysqldump属于逻辑备份,备份时是执行的sql语句.使用mysqlhotcopy命令前需要要安装相应的软件依赖包.<br style="word-spacing:normal;">
因为这个功能很弱，我们只简单的介绍一个怎么用：<br style="word-spacing:normal;">
备份一个库<br style="word-spacing:normal;">
mysqlhotcopy db_name [/path/to/new_directory]<br style="word-spacing:normal;">
备份一张表<br style="word-spacing:normal;">
mysqlhotcopy db_name./table_name/ /path/to/new_directory<br style="word-spacing:normal;">
更详细的使用可以使用perldoc mysqlhotcopy查看</p>
<h1 style="font-size:30px;font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.8;color:rgb(51,51,51);border:none;"><a name="t3"></a>
4.xtrabackup/innobackupex</h1>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
Percona XtraBackup是一款基于MySQL的热备份的开源实用程序，它可以备份5.1到5.7版本上InnoDB,XtraDB,MyISAM存储引擎的表，<br style="word-spacing:normal;">
Xtrabackup有两个主要的工具：xtrabackup、innobackupex<br style="word-spacing:normal;">
　　（1）xtrabackup只能备份InnoDB和XtraDB两种数据表，而不能备份MyISAM数据表<br style="word-spacing:normal;">
　　（2）innobackupex则封装了xtrabackup，是一个脚本封装，所以能同时备份处理innodb和myisam，但在处理myisam时需要加一个读锁<br style="word-spacing:normal;">
首先我们先来简单的了解一下xtrabackup是怎么工作的。xtrabackup基于innodb的crash-recovery（实例恢复）功能，先copy innodb的物理文件（这个时候数据的一致性是无法满足的），然后进行基于redo log进行恢复，达到数据的一致性。详细的信息可以参数https://www.percona.com/doc/percona-xtrabackup/LATEST/how_xtrabackup_works.html 我就不翻译了。<br style="word-spacing:normal;">
我们还是简单的来看一下日常工作中具体的使用：<br style="word-spacing:normal;">
全备：<br style="word-spacing:normal;">
xtrabackup --backup --target-dir=/data/backup/base<br style="word-spacing:normal;">
可以先看到<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493546229.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493546229.png" alt="8.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
在备份过程中,可以看到很多输出显示数据文件被复制,以及日志文件线程反复扫描日志文件和复制。<br style="word-spacing:normal;"><a class="example-image-link" href="http://www.aixchina.net/home/attachment/201704/30/898169_1493546337.png" rel="nofollow" style="word-spacing:normal;background:transparent;color:rgb(65,131,196);text-decoration:none;" target="_blank"><img class="example-image" src="http://www.aixchina.net/home/attachment/201704/30/898169_1493546337.png" alt="9.png" style="word-spacing:normal;border:0px;vertical-align:middle;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
同样的它也输出了当前的binlog filename和position，如果有gtid(同样也会输出) 可以用于搭建主从。最后一行一定会是你的lsn被copy的信息。<br style="word-spacing:normal;">
这是因为每次启动备份，都会记录170429 12:54:10 &gt;&gt; log scanned up to (1676085)），然后开始拷贝文件，一般来讲数据库越大拷贝文件是要花费越长的时间，所以说这期间一般情况都会有新的操作，所以说所有文件也可能记录的并不是一个时间点的数据，<br style="word-spacing:normal;">
为了解决数据这个问题，XtraBackup 就会启动一个后台进程来每秒1次的观测mysql的事务日志，直到备份结束。而且把事务日志中的改变记录下来。我们知道事物日志是会重用的（redo log）,所以这个进程会把redolog写到自己的日志文件xtrabackup_log，这个后台监控进程会记录所有的事务日志的改变，用于保证数据一致性所。<br style="word-spacing:normal;">
增量备份：<br style="word-spacing:normal;">
当我们做过全量备份以后会在目录下产生xtrabackup_checkpoints的文件 这里面记录了lsn和备份方式，我们可以基于这次的全量做增量的备份。<br style="word-spacing:normal;">
$cat xtrabackup_checkpoints<br style="word-spacing:normal;">
backup_type = full-backuped<br style="word-spacing:normal;">
from_lsn = 0<br style="word-spacing:normal;">
to_lsn = 1676085<br style="word-spacing:normal;">
last_lsn = 1676085<br style="word-spacing:normal;">
compact = 0<br style="word-spacing:normal;">
recover_binlog_info = 0</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
xtrabackup --backup --target-dir=/data/backup/inc1 --incremental-basedir=/data/backup/base<br style="word-spacing:normal;">
这个时候xtrabackup也是去打开了xtrabackup_checkpoints文件进行上一次备份的信息查看。这个时候去查看增量备份的xtrabackup_checkpoints也记录了这些信息<br style="word-spacing:normal;">
$cat xtrabackup_checkpoints&nbsp;<br style="word-spacing:normal;">
backup_type = incremental<br style="word-spacing:normal;">
from_lsn = 1676085<br style="word-spacing:normal;">
to_lsn = 1676085<br style="word-spacing:normal;">
last_lsn = 1676085<br style="word-spacing:normal;">
compact = 0<br style="word-spacing:normal;">
recover_binlog_info = 0<br style="word-spacing:normal;">
这也意味着你可以在增量的备份上继续增量的备份。</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
同样的xtrabackup也支持压缩（--compress）、加密（--encrypt）、并行(--parallel)等操作，但是和mysqlbackup不同的是这个没有同时的备份binlog,而mysqlbackup是备份了binlog的。</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
我们来模拟一个恢复的过程深入的了解一下原理<br style="word-spacing:normal;">
查看当前数据:<br style="word-spacing:normal;">
dbadmin@test 03:04:33&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
1 row in set (0.00 sec)<br style="word-spacing:normal;">
全量备份<br style="word-spacing:normal;">
$xtrabackup --backup --target-dir=/data/backup/base&nbsp;<br style="word-spacing:normal;">
模拟增量数据<br style="word-spacing:normal;">
dbadmin@test 03:07:16&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
2 rows in set (0.00 sec)<br style="word-spacing:normal;">
进行增量备份：<br style="word-spacing:normal;">
$xtrabackup --backup --target-dir=/data/backup/inc1 --incremental-basedir=/data/backup/base</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
模拟无备份操作：<br style="word-spacing:normal;">
dbadmin@test 03:09:42&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
| 3 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
3 rows in set (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
模拟误操作：<br style="word-spacing:normal;">
dbadmin@test 03:09:45&gt;truncate table t;<br style="word-spacing:normal;">
Query OK, 0 rows affected (0.00 sec)</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
摸拟恢复操作：<br style="word-spacing:normal;">
step 1:找到误操作的log position<br style="word-spacing:normal;">
dbadmin@test 03:10:19&gt;show master logs;<br style="word-spacing:normal;">
dbadmin@test 03:10:47&gt;show binlog events in 'mysql-bin.000001';<br style="word-spacing:normal;">
1333</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
我们需要分别对全量、增量备份各做一次prepare操作。<br style="word-spacing:normal;">
xtrabackup --prepare --apply-log-only --target-dir=/data/backup/base</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
增量<br style="word-spacing:normal;">
xtrabackup --prepare --apply-log-only --target-dir=/data/backup/base \<br style="word-spacing:normal;">
--incremental-dir=/data/backup/inc1</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
如果我们使用它自带的还原命令的时候就要先把data目录给清空。不然就会报如下的错误<br style="word-spacing:normal;">
$innobackupex --copy-back /data/backup/base/<br style="word-spacing:normal;">
170429 15:37:19 innobackupex: Starting the copy-back operation</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
IMPORTANT: Please check that the copy-back run completes successfully.<br style="word-spacing:normal;">
At the end of a successful copy-back run innobackupex<br style="word-spacing:normal;">
prints "completed OK!".</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
innobackupex version 2.4.6 based on MySQL server 5.7.13 Linux (x86_64) (revision id: 8ec05b7)<br style="word-spacing:normal;">
Original data directory /u01/my3307/data is not empty!<br style="word-spacing:normal;">
当然我们大多数据时候是不会在原来的实例上做操作的，都会把相应的备份在奇他的实例上进行恢复，然后再导出导入到误操作的实例。这里我们直接清掉目录，然后再次运行，查看恢复后的数据：<br style="word-spacing:normal;">
dbadmin@test 03:41:56&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
2 rows in set (0.00 sec)<br style="word-spacing:normal;">
同样的被恢复的目录里会多出来两个文件，一个是xtrabackup_binlog_pos_innodb，一个是xtrabackup_info。在这两个文件中都可以看到你最后的log,pos。在info里还可以看到lsn。我们基于这个pos再进行binlog的重演，恢复在binlog没有被备份的数据。<br style="word-spacing:normal;">
1076</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
$mysqlbinlog mysql-bin.000001 --start-position=1076 --stop-position=1333 -vv &gt;increment.sql</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
dbadmin@test 03:51:25&gt;source /u01/my3307/log/increment.sql<br style="word-spacing:normal;">
dbadmin@test 03:51:34&gt;select * from t;<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| id |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
| 1 |<br style="word-spacing:normal;">
| 2 |<br style="word-spacing:normal;">
| 3 |<br style="word-spacing:normal;">
+------+<br style="word-spacing:normal;">
3 rows in set (0.00 sec)<br style="word-spacing:normal;">
至此数据恢复完成</p>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
https://www.percona.com/doc/percona-xtrabackup/LATEST/backup_scenarios/full_backup.html</p>
<h1 style="font-size:30px;font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.8;color:rgb(51,51,51);border:none;"><a name="t4"></a>
5.直接复制整个数据库目录</h1>
<p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;">
　　MySQL有一种非常简单的备份方法，就是将MySQL中的数据库文件直接复制出来。这是最简单，速度最快的方法。<br style="word-spacing:normal;">
不过在此之前，要先将服务器停止，这样才可以保证在复制期间数据库的数据不会发生变化。如果在复制数据库的过程中还有数据写入，就会造成数据不一致。这种情况在开发环境可以，但是在生产环境中很难允许备份服务器。<br style="word-spacing:normal;">
注意：这种方法不适用于InnoDB存储引擎的表，而对于MyISAM存储引擎的表很方便。同时，还原时MySQL的版本最好相同。<br style="word-spacing:normal;">
只所以提这一点是因为当有停机窗口时，搭建主从的时候，这个往往是最快的。</p>
